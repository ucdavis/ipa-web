on:
  push:
    branches:
      - master

name: Push image to ECR and force new ECS deploy

jobs:
  setup:
    runs-on: ubuntu-latest
    steps:
      - name: Copy regional certificate bundle
        run: 'echo $RDS_US_WEST_2_BUNDLE_PEM | base64 -d > us-west-2-bundle.pem'
        shell: bash
        env:
          RDS_US_WEST_2_BUNDLE_PEM: ${{secrets.RDS_US_WEST_2_BUNDLE_PEM}}

  deploy:
    needs: setup
    uses: ucdavis-lsit/actions/.github/workflows/deploy.yml@main
    with:
      repo: 'ipa-web-prod'
      cluster: 'legacy'
      service: 'ipa-web-prod'
    secrets:
      access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
      secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
